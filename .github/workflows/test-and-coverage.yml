name: Test and Coverage

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-and-coverage:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install root dependencies
      run: npm ci

    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci

    - name: Install backend dependencies
      run: |
        cd backend
        npm ci

    - name: Run CI Tests
      run: npm run test:ci

    - name: Verify Coverage Generation
      run: |
        echo "🔍 Checking coverage file generation..."
        
        echo "Frontend coverage files:"
        if [ -d "frontend/coverage" ]; then
          find frontend/coverage -name "*.json" -o -name "*.info" -o -name "index.html" | head -10
        else
          echo "❌ Frontend coverage directory not found"
        fi
        
        echo "Backend coverage files:"
        if [ -d "backend/coverage" ]; then
          find backend/coverage -name "*.json" -o -name "*.info" -o -name "index.html" | head -10
        else
          echo "❌ Backend coverage directory not found"
        fi
        
        echo "CI summary files:"
        if [ -d "coverage/ci" ]; then
          find coverage/ci -name "*.json" | head -5
        else
          echo "❌ CI summary directory not found"
        fi

    - name: Organize Coverage Reports
      run: |
        mkdir -p coverage-reports/frontend
        mkdir -p coverage-reports/backend
        mkdir -p coverage-reports/ci
        
        # Copy frontend coverage if it exists
        if [ -d "frontend/coverage" ]; then
          cp -r frontend/coverage/* coverage-reports/frontend/
          echo "✅ Frontend coverage copied"
        else
          echo "❌ Frontend coverage not found"
        fi
        
        # Copy backend coverage if it exists
        if [ -d "backend/coverage" ]; then
          cp -r backend/coverage/* coverage-reports/backend/
          echo "✅ Backend coverage copied"
        else
          echo "❌ Backend coverage not found"
        fi
        
        # Copy CI summary if it exists
        if [ -d "coverage/ci" ]; then
          cp -r coverage/ci/* coverage-reports/ci/
          echo "✅ CI summary copied"
        else
          echo "❌ CI summary not found"
        fi
        
        # List the organized structure
        echo "📁 Coverage reports structure:"
        find coverage-reports -type f | head -20

    - name: Upload Frontend Coverage
      uses: actions/upload-artifact@v4
      with:
        name: frontend-coverage
        path: coverage-reports/frontend/
        retention-days: 30

    - name: Upload Backend Coverage
      uses: actions/upload-artifact@v4
      with:
        name: backend-coverage
        path: coverage-reports/backend/
        retention-days: 30

    - name: Upload Combined Coverage Reports
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: coverage-reports/
        retention-days: 30

    - name: Upload CI Summary
      uses: actions/upload-artifact@v4
      with:
        name: ci-summary
        path: coverage-reports/ci/
        retention-days: 30

    - name: Display Coverage Summary
      run: |
        echo "## 📊 Coverage Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "frontend/coverage/coverage-summary.json" ]; then
          echo "### Frontend Coverage" >> $GITHUB_STEP_SUMMARY
          node -e "
            const coverage = require('./frontend/coverage/coverage-summary.json');
            const total = coverage.total;
            console.log(\`- Statements: \${total.statements.pct}%\`);
            console.log(\`- Branches: \${total.branches.pct}%\`);
            console.log(\`- Functions: \${total.functions.pct}%\`);
            console.log(\`- Lines: \${total.lines.pct}%\`);
          " >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "backend/coverage/coverage-summary.json" ]; then
          echo "### Backend Coverage" >> $GITHUB_STEP_SUMMARY
          node -e "
            const coverage = require('./backend/coverage/coverage-summary.json');
            const total = coverage.total;
            console.log(\`- Statements: \${total.statements.pct}%\`);
            console.log(\`- Branches: \${total.branches.pct}%\`);
            console.log(\`- Functions: \${total.functions.pct}%\`);
            console.log(\`- Lines: \${total.lines.pct}%\`);
          " >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "coverage/ci/summary.json" ]; then
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          node -e "
            const summary = require('./coverage/ci/summary.json');
            console.log(\`- Frontend: \${summary.frontend.status === 'passed' ? '✅ PASSED' : '❌ FAILED'}\`);
            console.log(\`- Backend: \${summary.backend.status === 'passed' ? '✅ PASSED' : '❌ FAILED'}\`);
            console.log(\`- Overall: \${summary.overall.status === 'passed' ? '✅ PASSED' : '❌ FAILED'}\`);
          " >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./frontend/coverage/lcov.info,./backend/coverage/lcov.info
        flags: frontend,backend
        name: task-manager-coverage
        fail_ci_if_error: false
        verbose: true

    - name: Check Coverage Thresholds
      run: |
        echo "Checking coverage thresholds..."
        
        # Check if coverage meets minimum requirements (80%)
        if [ -f "frontend/coverage/coverage-summary.json" ]; then
          FRONTEND_STATEMENTS=$(node -e "console.log(require('./frontend/coverage/coverage-summary.json').total.statements.pct)")
          echo "Frontend statements coverage: ${FRONTEND_STATEMENTS}%"
          
          if (( $(echo "$FRONTEND_STATEMENTS < 80" | bc -l) )); then
            echo "❌ Frontend coverage below 80% threshold"
            exit 1
          else
            echo "✅ Frontend coverage meets 80% threshold"
          fi
        fi
        
        if [ -f "backend/coverage/coverage-summary.json" ]; then
          BACKEND_STATEMENTS=$(node -e "console.log(require('./backend/coverage/coverage-summary.json').total.statements.pct)")
          echo "Backend statements coverage: ${BACKEND_STATEMENTS}%"
          
          if (( $(echo "$BACKEND_STATEMENTS < 80" | bc -l) )); then
            echo "❌ Backend coverage below 80% threshold"
            exit 1
          else
            echo "✅ Backend coverage meets 80% threshold"
          fi
        fi
        
        echo "🎉 All coverage thresholds met!"